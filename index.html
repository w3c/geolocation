<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="color-scheme" content="light dark">
    <title>
      Geolocation
    </title>
    <script src="https://www.w3.org/Tools/respec/respec-w3c" async class=
    "remove"></script>
    <script class="remove">
    var respecConfig = {
      shortName: "geolocation",
      mdn: "geolocation-api",
      specStatus: "ED",
      editors: [
        {
          name: "Marcos Cáceres",
          company: "Apple Inc.",
          companyURL: "https://apple.com",
          w3cid: "39125",
        },
        {
          name: "Reilly Grant",
          company: "Google",
          companyURL: "https://google.com",
          w3cid: "83788",
        }
      ],
      formerEditors: [
        {
          name: "Andrei Popescu",
          company: "Google Inc.",
          companyURL: "https://google.com/",
        },
      ],
      group: [ "das", "webapps" ],
      previousPublishDate: "2022-02-17",
      crEnd: "2022-03-18",
      previousMaturity: "CR",
      github: "w3c/geolocation",
      caniuse: "geolocation",
      testSuiteURI: "https://wpt.live/geolocation/",
      implementationReportURI: "https://w3c.github.io/geolocation/reports/implementation.html",
      xref: "web-platform",
      errata: "https://w3c.github.io/geolocation/errata.html",
      latestVersion: "https://www.w3.org/TR/geolocation/",
    };
    </script>
  </head>
  <body data-cite=
  "secure-contexts permissions-policy permissions hr-time html">
    <section id="abstract">
      <p>
        Geolocation provides access to geographical location information
        associated with the hosting device.
      </p>
    </section>
    <section id="sotd" class="updateable-rec">
      <script class="removeOnSave">
        function updateableRecFilter(commit) {
          const { message } = commit;
          // only show commits that start with Addition: or Correction:
          return /^Addition:|^Correction:/.test(message);
        }
      </script>
      <p>
        Since this specification become a W3C Recommendation on 01 September
        2022, the following substantive additions and/or corrections have been
        proposed:
      </p><rs-changelog from="REC-2022" filter=
      "updateableRecFilter"></rs-changelog>
      <p>
        A more detailed list of changes can be found in section
        [[[#changelog]]]. Reviewers of the document can identify candidate
        additions and/or corrections by their distinctive styling in the
        document.
      </p>
    </section>
    <section id="introduction" class="informative">
      <h2>
        Introduction
      </h2>
      <p>
        <cite>Geolocation</cite> defines a high-level interface to location
        information associated only with the device hosting the implementation.
        Common sources of location information include Global Positioning
        System (GPS) and location inferred from network signals such as IP
        address, RFID, WiFi and Bluetooth MAC addresses, and GSM/CDMA cell IDs,
        as well as user input. The API itself is agnostic of the underlying
        <dfn>location information source</dfn>s, and no guarantee is given that
        the API returns the device's actual location.
      </p>
      <p>
        This specification provides two ways for users to share their location:
        a <em>precise position</em> and an <em>approximate position</em>.
      </p>
      <p>
        A <dfn>precise position</dfn> is a position returned by the underlying
        [=location information source=]. By default, any location data is
        considered precise, regardless of its accuracy estimate, unless it has
        been explicitly coarsened by an [=approximate location information
        source=] to be an [=approximate position=].
      </p>
      <p>
        An <dfn>approximate position</dfn> is a less precise,
        privacy-preserving representation of the user's location. Instead of
        providing precise coordinates, the user agent MUST return a location
        that is intentionally coarsened to a larger area, such as the nearest
        city, postal code, or a predefined region. This is often sufficient for
        applications that don't need to know the user's [=precise position=],
        for example, a weather application that only needs a city-level
        location. By sharing an [=approximate position=], users can still get
        the benefit of a location-aware application without revealing their
        [=precise position=].
      </p>
      <p>
        An <dfn>approximate location information source</dfn> is a [=location
        information source=] that returns positions that have been
        intentionally obfuscated to make it more difficult to recover the true
        location.
      </p>
      <p>
        If an end user [=check permission|grants permission=],
        <cite>Geolocation</cite>:
      </p>
      <ul>
        <li>Provides location data as latitude, longitude, altitude, speed, and
        heading, as well as the accuracy of the acquired location data, and the
        approximate time for when the position was acquired via the
        {{GeolocationPosition}} interface.
        </li>
        <li>Supports "one-shot" position updates via the
        {{Geolocation/getCurrentPosition()}} method and the ability to receive
        updates for when the position of the hosting device significantly
        changes via the {{Geolocation/watchPosition()}} method.
        </li>
        <li>Using the {{PositionOptions}}'s {{PositionOptions/maximumAge}},
        allows an application to request a cached position whose age is no
        greater than a specified value (only the last position is cached).
        </li>
        <li>Provides a way for the application to receive updates about errors,
        as a {{GeolocationPositionError}}, that have occurred while [=acquiring
        a position=].
        </li>
        <li>And through {{PositionOptions/enableHighAccuracy}}, supports
        requesting "high accuracy" position data, though the request can be
        ignored by the user agent.
        </li>
      </ul>
      <section id="scope" class="informative">
        <h3>
          Scope
        </h3>
        <p>
          This specification is limited to providing a scripting API for
          retrieving geographic position information associated with a hosting
          device. The geographic position information is provided in terms of
          World Geodetic System coordinates [[WGS84]]. It does not include
          providing a markup language of any kind, nor does not include
          defining a new URL scheme for building URLs that identify geographic
          locations.
        </p>
      </section>
    </section>
    <section class="informative">
      <h2>
        Examples
      </h2>
      <p>
        The API is designed to enable both "one-shot" position requests and
        repeated position updates. The following examples illustrate common use
        cases.
      </p>
      <section class="informative">
        <h3>
          Get current position
        </h3>
        <p>
          Request the user's current location. If the user allows it, you will
          get back a position object. The website can influence the position's
          accuracy by using the `accuracyMode` option. By default, the user
          agent will provide a `"precise"` location, but a website can request
          an `"approximate"` location if it doesn't require high accuracy,
          which helps protect user privacy.
        </p>
        <aside class="example" title="A one-shot position request">
          <pre class="js">
            navigator.geolocation.getCurrentPosition(position =&gt; {
              const { latitude, longitude } = position.coords;
              // Show a map centered at latitude / longitude.
            });
          </pre>
        </aside>
        <aside class="example" title="Requesting an approximate position">
          <pre class="js">
            navigator.geolocation.getCurrentPosition(position =&gt; {
              const { latitude, longitude } = position.coords;
              // Use the approximate location for city-level features, like showing weather.
            },
            console.error,
            { accuracyMode: "approximate" });
          </pre>
        </aside>
      </section>
      <section class="informative">
        <h3>
          Watch a position
        </h3>
        <p>
          Request the ability to watch user's current location. If the user
          allows it, you will get back continuous updates of the user's
          position.
        </p>
        <aside class="example" title=
        "Watching a position for repeated updates">
          <pre class="js">
            const watchId = navigator.geolocation.watchPosition(position =&gt; {
              const { latitude, longitude } = position.coords;
              // Show a map centered at latitude / longitude.
            });
          </pre>
        </aside>
      </section>
      <section class="informative">
        <h3>
          Stop watching a position
        </h3>
        <p>
          Stop watching for position changes by calling the
          {{Geolocation/clearWatch()}} method.
        </p>
        <aside class="example" title="Using clearWatch()">
          <pre class="js">
            const watchId = navigator.geolocation.watchPosition(
              position =&gt; console.log(position);
            );

            function buttonClickHandler() {
              // Cancel the updates when the user clicks a button.
              navigator.geolocation.clearWatch(watchId);
            }
          </pre>
          <p>
            And a HTML `button` that when pressed stops watching the position.
          </p>
          <pre class="html">
            &lt;button onclick="buttonClickHandler()"&gt;
              Stop watching location
            &lt;/button&gt;
          </pre>
        </aside>
      </section>
      <section class="informative">
        <h3>
          Handling errors
        </h3>
        <p>
          When an error occur, the second argument of the
          {{Geolocation/watchPosition()}} or
          {{Geolocation/getCurrentPosition()}} method gets called with a
          {{GeolocationPositionError}} error, which can help you figure out
          what might have gone wrong.
        </p>
        <aside class="example" title="Handling errors">
          <pre class="js">
            // Request repeated updates.
            const watchId = navigator.geolocation.watchPosition(
              scrollMap, handleError
            );

            function scrollMap(position) {
              const { latitude, longitude } = position.coords;
              // Scroll map to latitude / longitude.
            }

            function handleError(error) {
              // Display error based on the error code.
              const { code } = error;
              switch (code) {
                case GeolocationPositionError.TIMEOUT:
                  // Handle timeout.
                  break;
                case GeolocationPositionError.PERMISSION_DENIED:
                  // User denied the request.
                  break;
                case GeolocationPositionError.POSITION_UNAVAILABLE:
                  // Position not available.
                  break;
              }
            }
          </pre>
        </aside>
      </section>
      <section class="informative">
        <h3>
          Using `maximumAge` as cache control
        </h3>
        <p>
          By default, the API always attempts to return a cached position so
          long as it has a previously acquired position that matches the
          requested `accuracyMode`. In this example, we accept a precise
          position whose age is no greater than 10 minutes. If the user agent
          does not have a fresh enough cached position object of the correct
          accuracy, it automatically acquires a new position.
        </p>
        <aside class="example" title="Getting a cached precise position">
          <pre class="js">
            navigator.geolocation.getCurrentPosition(
              successCallback,
              console.error,
              { maximumAge: 600_000 } // `accuracyMode` defaults to "precise"
            );

            function successCallback(position) {
              // By using the 'maximumAge' member above, the position
              // object is guaranteed to be at most 10 minutes old.
            }
          </pre>
        </aside>
        <p>
          Similarly, you can request a cached approximate position.
        </p>
        <aside class="example" title="Getting a cached approximate position">
          <pre class="js">
            navigator.geolocation.getCurrentPosition(
              successCallback,
              console.error,
              { maximumAge: 600_000, accuracyMode: "approximate" }
            );

            function successCallback(position) {
              // This position is approximate and at most 10 minutes old.
            }
          </pre>
        </aside>
      </section>
      <section class="informative">
        <h2>
          Using `timeout`
        </h2>
        <p>
          If you require location information in a time sensitive manner, you
          can use the {{PositionOptions}} {{PositionOptions/timeout}} member to
          limit the amount of time you are willing to wait to [=acquire a
          position=].
        </p>
        <aside class="example" title="Timing out a position request">
          <pre class="js">
            // Request a position. We are only willing to wait 10
            // seconds for it.
            navigator.geolocation.getCurrentPosition(
              successCallback,
              errorCallback,
              { timeout: 10_000 }
            );

            function successCallback(position) {
              // Request finished in under 10 seconds...
            }

            function errorCallback(error) {
              switch (error.code) {
                case GeolocationPositionError.TIMEOUT:
                  // We didn't get it in a timely fashion.
                  doFallback();
                  // Acquire a new position object,
                  // as long as it takes.
                  navigator.geolocation.getCurrentPosition(
                    successCallback, errorCallback
                  );
                  break;
                case "...": // treat the other error cases.
              }
            }

            function doFallback() {}
          </pre>
        </aside>
      </section>
      <section class="informative">
        <h3>
          Enabling the API in third-party contexts
        </h3>
        <p>
          The [=policy-controlled feature/default allowlist=] of `'self'`
          allows API usage in same-origin nested frames but prevents
          third-party content from using the API.
        </p>
        <p>
          Third-party usage can be selectively enabled by adding the
          [^iframe/allow^]`="geolocation"` or `allow="geolocation-approximate"`
          attribute to an [^iframe^] element. Note that if `geolocation` is
          allowed, `geolocation-approximate` is also implicitly allowed.
        </p>
        <aside class="example" title="Enabling Geolocation in an iframe">
          <pre class="html">
            &lt;!-- This allows both precise and approximate geolocation --&gt;
            &lt;iframe
              src="https://third-party.com"
              allow="geolocation"&gt;
            &lt;/iframe&gt;

            &lt;!-- This allows only approximate geolocation --&gt;
            &lt;iframe
              src="https://another-third-party.com"
              allow="geolocation-approximate"&gt;
            &lt;/iframe&gt;
          </pre>
        </aside>
        <p>
          Alternatively, the API can be disabled in a first-party context by
          specifying an HTTP response header. Disabling
          `geolocation-approximate` will also disable `geolocation`.
        </p>
        <aside class="example" title="Permissions Policy over HTTP">
          <pre class="http">
            Permissions-Policy: geolocation-approximate=()
          </pre>
        </aside>
        <p>
          See [[[permissions-policy]]] for more details about the
          `Permissions-Policy` HTTP header.
        </p>
      </section>
    </section>
    <section id="privacy" class="informative">
      <h2>
        Privacy considerations
      </h2>
      <p>
        The API defined in this specification is used to retrieve the
        geographic location of a hosting device. In almost all cases, this
        information also discloses the location of the user of the device,
        thereby potentially compromising the user's privacy.
      </p>
      <p>
        To mitigate this privacy risk, this specification introduces the
        {{PositionOptions/accuracyMode}} option, which allows the application
        to request an [=approximate position=]. This allows applications to
        function without needing the user's [=precise position=], thus offering
        a more privacy-friendly alternative. When an application requests an
        [=approximate position=], the user agent can provide a less precise
        location that still meets the application's needs while protecting the
        user's [=precise position=]. Even when a [=precise position=] is
        requested, the user agent can provide an [=approximate position=]
        instead, for example, if the user has only granted permission for
        approximate accuracy.
      </p>
      <section class="informative">
        <h3>
          User consent
        </h3>
        <p>
          <cite>Geolocation</cite> is a [=powerful feature=] that requires
          [=express permission=] from an end-user before any location data is
          shared with a web application. This requirement is normatively
          enforced by the [=check permission=] steps on which the
          {{Geolocation/getCurrentPosition()}} and
          {{Geolocation/watchPosition()}} methods rely.
        </p>
        <p>
          An end-user will generally give [=express permission=] through a user
          interface. [=User agents=] with support for [=approximate position=]
          SHOULD allow the user to choose between sharing a [=precise
          position=] or an [=approximate position=]. This choice gives users
          more control over their privacy, allowing them to share a less
          precise location when they are not comfortable sharing their
          [=precise position=].
        </p>
        <p>
          The user interface will usually present a range of permission
          [=permission/lifetimes=] that the end-user can choose from. The
          choice of [=permission/lifetimes=] vary across user agents, but they
          are typically time-based (e.g., "a day"), or until browser is closed,
          or the user might even be given the choice for the permission to be
          granted indefinitely. The permission [=permission/lifetimes=] dictate
          how long a user agent [=permission/grants=] a permission before that
          permission is automatically reverted back to its default [=permission
          state=], prompting the end-user to make a new choice upon subsequent
          use.
        </p>
        <p>
          Although the granularity of the permission [=permission/lifetime=]
          varies across user-agents, this specification urges user agents to
          limit the lifetime to a single browsing session by default (see
          [[[#check-permission]]] for normative requirements).
        </p>
      </section>
      <section id="privacy_for_recipients" class="informative">
        <h3>
          Privacy considerations for recipients of location information
        </h3>
        <p class="note" title=
        "Developers' responsibility with this sensitive data">
          This section applies to "recipients", which generally means
          developers utilizing <cite>Geolocation</cite>. Although it's
          impossible for the user agent, or this specification, to enforce
          these requirements, developers need to read this section carefully
          and do their best to adhere to the suggestions below. Developers need
          to be aware that there might be privacy laws in their jurisdictions
          that can govern the usage and access to users' location data.
        </p>
        <p>
          Recipients ought to only request position information when necessary,
          and only use the location information for the task for which it was
          provided to them. Recipients ought to dispose of location information
          once that task is completed, unless expressly permitted to retain it
          by the user. Recipients need to also take measures to protect this
          information against unauthorized access. If location information is
          stored, users need to be allowed to update and delete this
          information.
        </p>
        <p>
          In line with this principle, recipients are strongly encouraged to
          request the lowest level of location accuracy that is sufficient for
          their application's functionality. For instance, if an application
          only needs to know the user's city, it should request an
          [=approximate position=] by setting the `accuracyMode` option to
          `"approximate"`. This is preferable to requesting a [=precise
          position=], which is done by either setting `accuracyMode` to
          `"precise"` or by leaving the option unset. This practice of data
          minimization is a key aspect of respecting user privacy.
        </p>
        <p>
          The recipients of location information need to refrain from
          retransmitting the location information without the user’s express
          permission. Care needs to be taken when retransmitting and the use of
          encryption is encouraged.
        </p>
        <p>
          Recipients ought to clearly and conspicuously disclose the fact that
          they are collecting location data, the purpose for the collection,
          how long the data is retained, how the data is secured, how the data
          is shared if it is shared, how users can access, update and delete
          the data, and any other choices that users have with respect to the
          data. This disclosure needs to include an explanation of any
          exceptions to the guidelines listed above.
        </p>
      </section>
      <section id="implementation_considerations" class="informative">
        <h3>
          Implementation considerations
        </h3>
        <p>
          Implementers are advised to consider the following aspects that can
          negatively affect the privacy of their users: in certain cases, users
          can inadvertently grant permission to the user agent to disclose
          their location to websites. In other cases, the content hosted at a
          certain URL changes in such a way that the previously granted
          location permissions no longer apply as far as the user is concerned.
          Or the users might simply change their minds.
        </p>
        <p>
          Predicting or preventing these situations is inherently difficult.
          Mitigation and in-depth defensive measures are an implementation
          responsibility and not prescribed by this specification. However, in
          designing these measures, implementers are advised to enable user
          awareness of location sharing, and to provide access to user
          interfaces that enable revocation of permissions.
        </p>
      </section>
      <section id="check-permission">
        <h2>
          Checking permission to use the API
        </h2>
        <p>
          <cite>Geolocation</cite> is a [=default powerful feature=] identified
          by the [=powerful feature/name=]s <code><dfn class=
          "permission">"geolocation"</dfn></code> for [=precise position=] and
          <code><dfn class="permission">"geolocation-approximate"</dfn></code>
          for [=approximate position=].
        </p>
        <p>
          When a website requests location access, the user agent [=check
          permission|checks permission=] for the level of accuracy specified by
          the {{PositionOptions/accuracyMode}} option. A grant for the
          "geolocation" permission implies a grant for the
          "geolocation-approximate" permission, while if the
          "geolocation-approximate" is denied, then so is "geolocation".
        </p>
        <p>
          When <dfn data-local-lt="check permission">checking permission</dfn>
          to use the API, a user agent SHOULD present the user with a choice to
          grant access to their [=precise position=], their [=approximate
          position=], or to deny the request. A user agent MAY also suggest
          time-based [=permission=] [=permission/lifetimes=], such as "24
          hours", "1 week", or choose to remember the permission
          [=permission/grant=] indefinitely. However, it is RECOMMENDED that a
          user agent prioritize restricting the [=permission=]
          [=permission/lifetime=] to a single session: This can be, for
          example, until the [=environment settings object/realm=] is
          destroyed, the end-user [=navigates=] away from the [=origin=], or
          the relevant browser tab is closed.
        </p>
      </section>
      <section>
        <h3>
          Preventing Precise Location Reconstruction
        </h3>
        <p>
          A malicious actor could potentially infer a user's [=precise
          position=] by collecting and correlating multiple, distinct
          [=approximate position=]s. To mitigate this risk of a refinement
          attack, when a site receives an [=approximate position=], any
          subsequent calls from that same site within a user-agent-defined time
          window SHOULD return the exact same, cached [=approximate position=]
          data. A user agent might, for example, use a time window of 15
          minutes.
        </p>
      </section>
    </section>
    <section id="security">
      <h2>
        Security considerations
      </h2>
      <p>
        There are no security considerations associated with Geolocation at the
        time of publication. However, readers are advised to read the
        [[[#privacy]]].
      </p>
    </section>
    <section id="navigator_interface" data-dfn-for="Navigator">
      <h2>
        Extensions to the `Navigator` interface
      </h2>
      <pre class="idl">
        partial interface Navigator {
          [SameObject] readonly attribute Geolocation geolocation;
        };
      </pre>
    </section>
    <section id="geolocation_interface" data-dfn-for="Geolocation">
      <h2>
        `Geolocation` interface and callbacks
      </h2>
      <pre class="idl">
        [Exposed=Window]
        interface Geolocation {
          undefined getCurrentPosition (
            PositionCallback successCallback,
            optional PositionErrorCallback? errorCallback = null,
            optional PositionOptions options = {}
          );

          long watchPosition (
            PositionCallback successCallback,
            optional PositionErrorCallback? errorCallback = null,
            optional PositionOptions options = {}
          );

          undefined clearWatch (long watchId);
        };

        callback PositionCallback = undefined (
          GeolocationPosition position
        );

        callback PositionErrorCallback = undefined (
          GeolocationPositionError positionError
        );
      </pre>
      <section>
        <h2>
          Internal slots
        </h2>
        <p>
          Instances of {{Geolocation}} are created with the internal slots in
          the following table:
        </p>
        <table class="data">
          <tr>
            <th>
              Internal slot
            </th>
            <th>
              Description
            </th>
          </tr>
          <tr>
            <td>
              <dfn data-dfn-for="Geolocation">[[\cachedPrecisePosition]]</dfn>
            </td>
            <td>
              A {{GeolocationPosition}}, initialized to null. It's a reference
              to the last acquired [=precise position=] and serves as a cache.
              A user agent MAY evict {{Geolocation/[[cachedPrecisePosition]]}}
              by resetting it to null at any time for any reason.
            </td>
          </tr>
          <tr>
            <td>
              <dfn data-dfn-for=
              "Geolocation">[[\cachedApproximatePosition]]</dfn>
            </td>
            <td>
              A {{GeolocationPosition}}, initialized to null. It's a reference
              to the last acquired [=approximate position=] and serves as a
              cache. A user agent MAY evict
              {{Geolocation/[[cachedApproximatePosition]]}} by resetting it to
              null at any time for any reason.
            </td>
          </tr>
          <tr>
            <td>
              <del><dfn data-dfn-for=
              "Geolocation">[[\cachedPosition]]</dfn></del>
            </td>
            <td>
              <del>A {{GeolocationPosition}}, initialized to null. It's a
              reference to the last acquired position and serves as a cache. A
              user agent MAY evict {{Geolocation/[[cachedPosition]]}} by
              resetting it to null at any time for any reason.</del>
            </td>
          </tr>
          <tr>
            <td>
              <dfn data-dfn-for="Geolocation">[[\watchIDs]]</dfn>
            </td>
            <td>
              Initialized as an empty [=list=] of {{unsigned long}}
              [=list/item|items=].
            </td>
          </tr>
        </table>
      </section>
      <section>
        <h2>
          `getCurrentPosition()` method
        </h2>
        <p data-tests=
        "getCurrentPosition_IDL.https.html, getCurrentPosition_TypeError.html">
          The <dfn>getCurrentPosition</dfn>(|successCallback:PositionCallback|,
          |errorCallback:PositionErrorCallback?|, |options:PositionOptions|)
          method steps are:
        </p>
        <ol class="algorithm">
          <li>
            <aside class="correction" id="c1">
              <span class="marker">Candidate Correction:</span> Updated
              reference to the global object to use [=this=] for consistency in
              error handling within geolocation retrieval.
            </aside><del cite="#c1">If the [=current settings object=]'s
            [=relevant global object=]'s [=associated `Document`=] is not
            [=Document/fully active=]:</del> <ins cite="#c1">If [=this=]'s
            [=relevant global object=]'s [=associated `Document`=] is not
            [=Document/fully active=]:</ins>
            <ol>
              <li>[=Call back with error=] |errorCallback| and
              {{GeolocationPositionError/POSITION_UNAVAILABLE}}.
              </li>
              <li>Terminate this algorithm.
              </li>
            </ol>
          </li>
          <li>[=Request a position=] passing [=this=], |successCallback|,
          |errorCallback|, and |options|.
          </li>
        </ol>
      </section>
      <section>
        <h2>
          `watchPosition()` method
        </h2>
        <p data-tests=
        "getCurrentPosition_permission_allow.https.html, getCurrentPosition_permission_deny.https.html">
          The <dfn>watchPosition</dfn>(|successCallback:PositionCallback|,
          |errorCallback:PositionErrorCallback?|, |options:PositionOptions|)
          method steps are:
        </p>
        <ol class="algorithm">
          <li>
            <aside class="correction" id="c2">
              <span class="marker">Candidate Correction:</span> Simplified
              reference to the global object in the method steps for checking
              document's activity status.
            </aside><del cite="#c2">If the [=current settings object=]'s
            [=relevant global object=]'s [=associated `Document`=] is not
            [=Document/fully active=]:</del> <ins cite="#c2">If [=this=]'s
            [=relevant global object=]'s [=associated `Document`=] is not
            [=Document/fully active=]:</ins>
            <ol>
              <li>[=Call back with error=] passing |errorCallback| and
              {{GeolocationPositionError/POSITION_UNAVAILABLE}}.
              </li>
              <li>Return 0.
              </li>
            </ol>
          </li>
          <li>Let |watchId:unsigned long| be an [=implementation-defined=]
          {{unsigned long}} that is greater than zero.
          </li>
          <li>[=List/Append=] |watchId| to [=this=]'s
          {{Geolocation/[[watchIDs]]}}.
          </li>
          <li>[=Request a position=] passing [=this=], |successCallback|,
          |errorCallback|, |options|, and |watchId|.
          </li>
          <li>Return |watchId|.
          </li>
        </ol>
      </section>
      <section>
        <h2>
          `clearWatch()` method
        </h2>
        <p data-tests="clearWatch_TypeError.html">
          When <dfn>clearWatch()</dfn> is invoked, the user agent MUST:
        </p>
        <ol class="algorithm">
          <li>[=List/Remove=] |watchId| from [=this=]'s
          {{Geolocation/[[watchIDs]]}}.
          </li>
        </ol>
      </section>
      <section>
        <h2>
          Request a position
        </h2>
        <p>
          To <dfn>request a position</dfn>, pass a {{Geolocation}}
          |geolocation:Geolocation|, a {{PositionCallback}}
          |successCallback:PositionCallback|, a {{PositionErrorCallback?}}
          |errorCallback:PositionErrorCallback?|, a {{PositionOptions}}
          |options:PositionOptions|, and an optional |watchId:unsigned long|:
        </p>
        <ol class="algorithm">
          <li>Let |watchIDs:List| be |geolocation|'s
          {{Geolocation/[[watchIDs]]}}.
          </li>
          <li>Let |document:Document| be the |geolocation|'s [=relevant global
          object=]'s [=associated `Document`=].
          </li>
          <li>Let |permissionName| be "geolocation-approximate" if
          |options|.{{PositionOptions/accuracyMode}} is "approximate",
          otherwise let it be "geolocation".
          </li>
          <li data-tests="">If |document| is not [=allowed to use=] the
          |permissionName| feature:
            <ol>
              <li>If |watchId| was passed, [=List/remove=] |watchId| from
              |watchIDs|.
              </li>
              <li>[=Call back with error=] passing |errorCallback| and
              {{GeolocationPositionError/PERMISSION_DENIED}}.
              </li>
              <li>Terminate this algorithm.
              </li>
            </ol>
          </li>
          <li>
            <aside class="correction" id="c7">
              <span class="marker">Candidate Correction:</span> Added missing
              step to handle [=non-secure contexts=].
            </aside><ins cite="#c7">If |geolocation|'s [=environment settings
            object=] is a [=non-secure context=]:
            <ol>
              <li>If |watchId| was passed, [=List/remove=] |watchId| from
              |watchIDs|.
              </li>
              <li>[=Call back with error=] passing |errorCallback| and
              {{GeolocationPositionError/PERMISSION_DENIED}}.
              </li>
              <li>Terminate this algorithm.
              </li>
            </ol></ins>
          </li>
          <li>If |document:Document|'s [=Document/visibility state=] is
          "hidden", wait for the following [=page visibility change steps=] to
          run:
            <ol>
              <li>Assert: |document|'s [=Document/visibility state=] is
              "visible".
              </li>
              <li>Continue to the next steps below.
              </li>
            </ol>
          </li>
          <li>Let |descriptor| be a new {{PermissionDescriptor}} whose
          {{PermissionDescriptor/name}} is |permissionName|.
          </li>
          <li>[=In parallel=]:
            <ol>
              <li>Set |permission| to [=request permission to use=]
              |descriptor|.
              </li>
              <li>Let |handle permission denial| be the following steps:
                <ol>
                  <li>If |watchId| was passed, [=list/remove=] |watchId| from
                  |watchIDs|.
                  </li>
                  <li>[=Call back with error=] passing |errorCallback| and
                  {{GeolocationPositionError/PERMISSION_DENIED}}.
                  </li>
                  <li>Terminate this algorithm.
                  </li>
                </ol>
              </li>
              <li data-tests=
              "getCurrentPosition_permission_allow.https.html, getCurrentPosition_permission_deny.https.html">
              If |permission| is "denied":
                <ol>
                  <li>If |options|.{{PositionOptions/accuracyMode}} is
                  "approximate", then run |handle permission denial|.
                  </li>
                  <li>Otherwise:
                    <ol>
                      <li>Let |approximatePermission| be [=get the current
                      permission state=] of "geolocation-approximate".
                      </li>
                      <li>If |approximatePermission| is "denied", then run
                      |handle permission denial|.
                      </li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Wait to [=acquire a position=] passing |successCallback|,
              |errorCallback|, |options|, and |watchId|.
              </li>
              <li>If |watchId| was not passed, terminate this algorithm.
              </li>
              <li>While |watchIDs| [=list/contains=] |watchId|:
                <ol>
                  <li>
                    <span id="wait-for-change">Wait for a significant change of
                    geographic position</span>. What constitutes a significant
                    change of geographic position is left to the
                    implementation. User agents MAY impose a rate limit on how
                    frequently position changes are reported. <ins cite=
                    "#a4">User agents MUST consider invoking [=set emulated
                    position data=] as a significant change.</ins>
                  </li>
                  <li>If |document| is not [=Document/fully active=] or
                  [=Document/visibility state=] is not "visible", go back to
                  the previous step and again <a href="#wait-for-change">wait
                  for a significant change of geographic position</a>.
                    <aside class="note" title=
                    "Position updates are exclusively for fully-active visible documents">
                      <p>
                        The desired effect here being that position updates are
                        exclusively delivered to fully active documents that
                        are visible; Otherwise the updates get silently
                        "dropped on the floor". Only once a document again
                        becomes fully active and visible (e.g., an [^iframe^]
                        gets reattached to a parent document), do the position
                        updates once again start getting delivered.
                      </p>
                    </aside>
                  </li>
                  <li>Wait to [=acquire a position=] passing |successCallback|,
                  |errorCallback|, |options|, and |watchId|.
                  </li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <section>
        <h2>
          Acquire a position
        </h2>
        <p>
          To <dfn data-local-lt=
          "acquiring a position|acquire a position">acquire a position</dfn>,
          passing {{PositionCallback}} |successCallback:PositionCallback|, a
          {{PositionErrorCallback?}} |errorCallback:PositionErrorCallback?|,
          {{PositionOptions}} |options:PositionOptions|, and an optional
          |watchId:unsigned long|.
        </p>
        <ol class="algorithm">
          <li>If |watchId| was passed and [=this=]'s
          {{Geolocation/[[watchIDs]]}} does not [=list/contain=] |watchId|,
          terminate this algorithm.
          </li>
          <li>Let |acquisitionTime:EpochTimeStamp| be a new {{EpochTimeStamp}}
          that represents now.
          </li>
          <li>Let |timeoutTime| be the sum of |acquisitionTime| and
          |options|.{{PositionOptions/timeout}}.
          </li>
          <li>Create an implementation-specific |timeout| task that elapses at
          |timeoutTime|, during which it tries to acquire the device's position
          by running the following steps:
            <ol>
              <li>Let |precisePermission| be [=get the current permission
              state=] of "geolocation".
              </li>
              <li>Let |approximatePermission| be [=get the current permission
              state=] of "geolocation-approximate".
              </li>
              <li>Let |effectiveAccuracy| be null.
              </li>
              <li>If |options|.{{PositionOptions/accuracyMode}} is
              "approximate":
                <ol>
                  <li>If |approximatePermission| is "granted", set
                  |effectiveAccuracy| to "approximate".
                  </li>
                </ol>
              </li>
              <li>Otherwise, if |options|.{{PositionOptions/accuracyMode}} is
              "precise":
                <ol>
                  <li>If |precisePermission| is "granted", set
                  |effectiveAccuracy| to "precise".
                  </li>
                  <li>Otherwise, if |approximatePermission| is "granted", set
                  |effectiveAccuracy| to "approximate".
                  </li>
                </ol>
              </li>
              <li>If |effectiveAccuracy| is null:
                <ol>
                  <li>Stop |timeout|.
                  </li>
                  <li>Do the <a href="#permission-denied">user or system denied
                  permission</a> failure case step.
                  </li>
                  <li>Terminate this algorithm.
                  </li>
                </ol>
              </li>
              <li>
                <ins cite="#a4">Check if an emulated position should be used by
                running the following steps:
                <ol>
                  <li>Let |emulatedPositionData| be [=get emulated position
                  data=] passing [=this=].
                  </li>
                  <li>If |emulatedPositionData| is not null:
                    <ol>
                      <li>If |emulatedPositionData| is a
                      {{GeolocationPositionError}}:
                        <ol>
                          <li>[=Call back with error=] passing |errorCallback|
                          and
                          |emulatedPositionData|.{{GeolocationPositionError/code}}.
                          </li>
                          <li>Terminate this algorithm.
                          </li>
                        </ol>
                      </li>
                      <li>Let |position| be [=a new `GeolocationPosition`=]
                      passing |emulatedPositionData|, |acquisitionTime|,
                      |options|.{{PositionOptions/enableHighAccuracy}}, and
                      |effectiveAccuracy|.
                      </li>
                      <li>[=Queue a task=] on the [=geolocation task source=]
                      with a step that [=invokes=] |successCallback| with «
                      |position| » and "`report`".
                      </li>
                      <li>Terminate this algorithm.
                      </li>
                    </ol>
                  </li>
                </ol></ins>
              </li>
              <li>Let |cachedPosition| be null.
              </li>
              <li>If |effectiveAccuracy| is "precise":
                <ol>
                  <li>Set |cachedPosition| to [=this=]'s
                  {{Geolocation/[[cachedPrecisePosition]]}}.
                  </li>
                </ol>
              </li>
              <li>Otherwise, if |effectiveAccuracy| is "approximate":
                <ol>
                  <li>Set |cachedPosition| to [=this=]'s
                  {{Geolocation/[[cachedApproximatePosition]]}}.
                  </li>
                </ol>
              </li>
              <li>Let |position| be null.
              </li>
              <li>If |cachedPosition| is not null, and
              |options|.{{PositionOptions/maximumAge}} is greater than 0:
                <ol>
                  <li>Let |cacheTime:long| be |acquisitionTime| minus the value
                  of the |options|.{{PositionOptions/maximumAge}} member.
                  </li>
                  <li>
                    <aside class="correction" id="c8">
                      <span class="marker">Candidate Correction:</span> Updated
                      to ensure that the algorithm terminates immediately if a
                      valid cached position is used, avoiding unnecessary
                      steps.
                    </aside>If |cachedPosition|'s
                    {{GeolocationPosition/timestamp}}'s value is greater than
                    |cacheTime|, and (|effectiveAccuracy| is "approximate" or
                    (|effectiveAccuracy| is "precise" and
                    |cachedPosition|.{{GeolocationPosition/[[isHighAccuracy]]}}
                    equals
                    |options|.{{PositionOptions/enableHighAccuracy}}))<del cite="#c8">,
                    set |position| to |cachedPosition|.</del> <ins cite="#c8">:
                    <ol>
                      <li>[=Queue a task=] on the [=geolocation task source=]
                      with a step that [=invokes=] |successCallback| with «
                      |cachedPosition| » and "`report`".
                      </li>
                      <li>Terminate this algorithm.
                      </li>
                    </ol></ins>
                  </li>
                </ol>
              </li>
              <li>Otherwise, if |position| is not |cachedPosition|, try to
              acquire position data from the underlying system, with the
              following considerations:
                <ol>
                  <li>If |effectiveAccuracy| is "approximate", the user agent
                  SHOULD acquire a position with a level of accuracy that is
                  sufficient to protect user privacy (e.g., city-level
                  accuracy). The {{PositionOptions/enableHighAccuracy}} member
                  is ignored.
                  </li>
                  <li>If |effectiveAccuracy| is "precise", the user agent
                  SHOULD acquire a position, optionally taking into
                  consideration the value of
                  |options|.{{PositionOptions/enableHighAccuracy}}.
                  </li>
                </ol>
              </li>
              <li>If the |timeout| elapses during acquisition, or acquiring the
              device's position results in failure:
                <ol>
                  <li>Stop the |timeout|.
                  </li>
                  <li>Go to <a href="#errors-reasons">dealing with
                  failures</a>.
                  </li>
                  <li>Terminate this algorithm.
                  </li>
                </ol>
              </li>
              <li data-cite="infra">If acquiring the position data from the
              system succeeds:
                <aside class="correction" id="c9">
                  <span class="marker">Candidate Correction:</span> We now use
                  a [=map=] to represent the position data. Clarified the units
                  and reference systems for latitude, longitude, and altitude,
                  ensuring consistency with the updated attribute definitions.
                  Updated the descriptions of the speed and heading to specify
                  measurement units and conditions for null values, aligning
                  with the overall enhancements to attribute accuracy and
                  clarity.
                </aside><ins cite="#c9">
                <ol data-cite="infra">
                  <li>Let |positionData| be a [=map=] with the following
                  name/value pairs based on the acquired position data:
                    <dl>
                      <dt>
                        "longitude"
                      </dt>
                      <dd>
                        A {{double}} that represents the longitude coordinates
                        on the Earth's surface in degrees, using the [[WGS84]]
                        coordinate system. Longitude measures how far east or
                        west a point is from the Prime Meridian.
                      </dd>
                      <dt>
                        "altitude"
                      </dt>
                      <dd>
                        A {{double?}} that represents the altitude in meters
                        above the [[WGS84]] ellipsoid, or `null` if not
                        available. Altitude measures the height above sea
                        level.
                      </dd>
                      <dt>
                        "accuracy"
                      </dt>
                      <dd>
                        A non-negative {{double}} that represents the accuracy
                        value indicating the 95% confidence level in meters.
                        Accuracy measures how close the measured coordinates
                        are to the true position.
                      </dd>
                      <dt>
                        "altitudeAccuracy"
                      </dt>
                      <dd>
                        A non-negative {{double?}} that represents the altitude
                        accuracy, or `null` if not available, indicating the
                        95% confidence level in meters. Altitude accuracy
                        measures how close the measured altitude is to the true
                        altitude.
                      </dd>
                      <dt>
                        "speed"
                      </dt>
                      <dd>
                        A non-negative {{double?}} that represents the speed in
                        meters per second, or `null` if not available. Speed
                        measures how fast the device is moving.
                      </dd>
                      <dt>
                        "heading"
                      </dt>
                      <dd>
                        A {{double?}} that represents the heading in degrees,
                        or `null` if not available or the device is stationary.
                        Heading measures the direction in which the device is
                        moving relative to true north.
                      </dd>
                    </dl>
                  </li>
                  <li>Set |position| to [=a new `GeolocationPosition`=] passing
                  |positionData|, |acquisitionTime|,
                  |options|.{{PositionOptions/enableHighAccuracy}}, and
                  |effectiveAccuracy|.
                  </li>
                  <li>If |effectiveAccuracy| is "precise":
                    <ol>
                      <li>Set [=this=]'s
                      {{Geolocation/[[cachedPrecisePosition]]}} to |position|.
                      </li>
                    </ol>
                  </li>
                  <li>Otherwise, if |effectiveAccuracy| is "approximate":
                    <ol>
                      <li>Set [=this=]'s
                      {{Geolocation/[[cachedApproximatePosition]]}} to
                      |position|.
                      </li>
                    </ol>
                  </li>
                </ol></ins> <del cite="#c9">
                <ol>
                  <li>Set |position| to [=a new `GeolocationPosition`=] passing
                  |acquisitionTime| and
                  |options|.{{PositionOptions/enableHighAccuracy}}.
                  </li>
                  <li>Set [=this=]'s {{Geolocation/[[cachedPosition]]}} to
                  |position|.
                  </li>
                </ol></del>
              </li>
              <li>Stop the |timeout|.
              </li>
              <li>[=Queue a task=] on the [=geolocation task source=] with a
              step that [=invokes=] |successCallback| with « |position| » and
              "`report`".
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <section>
        <h2>
          Call back with error
        </h2>
        <p>
          When instructed to <dfn>call back with error</dfn>, given an
          {{PositionErrorCallback?}} |callback:PositionErrorCallback?| and an
          {{unsigned short}} |code:unsigned short|:
        </p>
        <ol class="algorithm">
          <li>If |callback| is null, return.
          </li>
          <li>Let |error:GeolocationPositionError| be a newly created
          {{GeolocationPositionError}} instance whose
          {{GeolocationPositionError/code}} attribute is initialized to |code|.
          </li>
          <li>[=Queue a task=] on the [=geolocation task source=] with a step
          that [=invokes=] |callback| with « |error| » and "`report`".
          </li>
        </ol>
      </section>
    </section>
    <section id="position_options_interface" data-dfn-for="PositionOptions">
      <h2>
        <dfn>PositionOptions</dfn> dictionary
      </h2>
      <pre class="idl">
        enum AccuracyMode {
          "precise",
          "approximate"
        };

        dictionary PositionOptions {
          AccuracyMode accuracyMode = "precise";
          boolean enableHighAccuracy = false;
          [Clamp] unsigned long timeout = 0xFFFFFFFF;
          [Clamp] unsigned long maximumAge = 0;
        };
        </pre>
      <section>
        <h2>
          `accuracyMode` member
        </h2>
        <p>
          The <dfn>accuracyMode</dfn> member is used to request a specific
          level of accuracy. It can be set to "precise" to request the most
          accurate location data available, or "approximate" to receive a less
          accurate location that protects user privacy. The default value is
          "precise".
        </p>
        <aside class="note" title="Interaction with enableHighAccuracy">
          <p>
            If `accuracyMode` is set to "approximate", the `enableHighAccuracy`
            member has no effect.
          </p>
        </aside>
      </section>
      <section>
        <h2>
          `enableHighAccuracy` member
        </h2>
        <p data-tests="PositionOptions.https.html">
          The <dfn>enableHighAccuracy</dfn> member provides a hint that the
          application would like to receive the most accurate location data.
          The intended purpose of this member is to allow applications to
          inform the implementation that they do not require high accuracy
          geolocation fixes and, therefore, the implementation MAY avoid using
          geolocation providers that consume a significant amount of power
          (e.g., GPS).
        </p>
        <aside class="note" title="A word of warning about enableHighAccuracy">
          <p>
            The `enableHighAccuracy` member can result in slower response times
            or increased power consumption. The user might also disable this
            capability, or the device might not be able to provide more
            accurate results than if the flag wasn't specified.
          </p>
        </aside>
      </section>
      <section>
        <h2>
          `timeout` member
        </h2>
        <p data-tests="PositionOptions.https.html">
          The <dfn>timeout</dfn> member denotes the maximum length of time,
          expressed in milliseconds, before [=acquiring a position=] expires.
        </p>
        <p class="note" title="When is the timeout calculated?">
          The time spent waiting for the document to become visible and for
          [=check permission|obtaining permission to use the API=] is not
          included in the period covered by the {{PositionOptions/timeout}}
          member. The {{PositionOptions/timeout}} member only applies when
          [=acquiring a position=] begins.
        </p>
        <aside class="note" title="Immediate cancellation">
          <p>
            An |options|.{{PositionOptions/timeout}} value 0 can cause
            immediate failures.
          </p>
        </aside>
      </section>
      <section>
        <h2>
          `maximumAge` member
        </h2>
        <p data-tests="PositionOptions.https.html">
          The <dfn>maximumAge</dfn> member indicates that the web application
          is willing to accept a cached position whose age is no greater than
          the specified time in milliseconds.
        </p>
      </section>
    </section>
    <section id="position_interface" data-dfn-for="GeolocationPosition">
      <h2>
        `GeolocationPosition` interface
      </h2>
      <pre class="idl">
        [Exposed=Window, SecureContext]
        interface GeolocationPosition {
          readonly attribute GeolocationCoordinates coords;
          readonly attribute EpochTimeStamp timestamp;
          readonly attribute AccuracyMode accuracyMode;
          [Default] object toJSON();
        };
      </pre>
      <section>
        <h3>
          `coords` attribute
        </h3>
        <p>
          The <dfn>coords</dfn> attribute contains geographic coordinates.
        </p>
      </section>
      <section>
        <h3>
          `timestamp` attribute
        </h3>
        <p>
          The <dfn>timestamp</dfn> attribute represents the time when the
          geographic position of the device was acquired.
        </p>
      </section>
      <section>
        <h3>
          `accuracyMode` attribute
        </h3>
        <p>
          The <dfn>accuracyMode</dfn> attribute indicates the accuracy level of
          the position, which can be either `"precise"` or `"approximate"`.
          This reflects the level of accuracy that was granted and used to
          obtain the position.
        </p>
      </section>
      <section>
        <h3>
          `toJSON()` method
        </h3>
        <aside class="addition" id="a1">
          <span class="marker">Candidate Addition:</span> Introduce a
          `toJSON()` method to allow the {{GeolocationPosition}} object to be
          easily converted into a JSON representation, facilitating
          interoperability and ease of use in web applications.
        </aside>
        <p>
          <ins cite="#a1">The <dfn>toJSON()</dfn> method returns a JSON
          representation of the {{GeolocationPosition}} object.</ins>
        </p>
      </section>
      <section>
        <h2>
          Internal slots
        </h2>
        <p>
          Instances of {{GeolocationPositionError}} are created with the
          internal slots in the following table:
        </p>
        <table class="data">
          <tr>
            <th>
              Internal slot
            </th>
            <th>
              Description
            </th>
          </tr>
          <tr>
            <td>
              <dfn data-dfn-for="GeolocationPosition">[[\isHighAccuracy]]</dfn>
            </td>
            <td>
              A {{boolean}} that records the value of the
              {{PositionOptions/enableHighAccuracy}} member when this
              {{GeolocationPosition}} is [=a new GeolocationPosition|created=].
            </td>
          </tr>
        </table>
      </section>
      <section>
        <h2>
          Task sources
        </h2>
        <p>
          The following [=task source=] is defined by this specifications.
        </p>
        <dl>
          <dt>
            The <dfn>geolocation task source</dfn>
          </dt>
          <dd>
            Used by this specification to queue up non-blocking
            {{PositionCallback}} and {{PositionErrorCallback}} when performing
            [=request a position|position requests=].
          </dd>
        </dl>
      </section>
    </section>
    <section id="coordinates_interface" data-dfn-for="GeolocationCoordinates">
      <h2>
        <dfn>GeolocationCoordinates</dfn> interface
      </h2>
      <pre class="idl">
        [Exposed=Window, SecureContext]
        interface GeolocationCoordinates {
          readonly attribute double accuracy;
          readonly attribute double latitude;
          readonly attribute double longitude;
          readonly attribute double? altitude;
          readonly attribute double? altitudeAccuracy;
          readonly attribute double? heading;
          readonly attribute double? speed;
          [Default] object toJSON();
        };
      </pre>
      <section>
        <h4>
          `latitude`, `longitude`, and `accuracy` attributes
        </h4>
        <aside class="correction" id="c3">
          <span class="marker">Candidate Correction:</span> To improve clarity
          and precision, the description of latitude and longitude attributes
          has been updated to specify that these are real numbers in degrees
          according to the [[WGS84]] geodetic system, instead of just stating
          "decimal degrees."
        </aside>
        <aside class="addition" id="a3">
          <span class="marker">Candidate Addition:</span> To improve clarity
          and precision, a description of the accuracy attribute has been
          added, defining it as meters of radius.
        </aside>
        <p>
          <del cite="#c3">The <strong>latitude</strong> and
          <strong>longitude</strong> attributes are geographic coordinates
          specified in decimal degrees.</del> <ins cite="#c3">The
          <dfn>latitude</dfn> and <dfn>longitude</dfn> attributes denote the
          position, specified as a real number of degrees, in the [[WGS84]]
          coordinate system.</ins> <ins cite="#a3">The <dfn>accuracy</dfn>
          attribute denotes the position accuracy radius in meters.</ins>
        </p>
      </section>
      <section>
        <h4>
          `altitude` and `altitudeAccuracy` attributes
        </h4>
        <p>
          The <dfn>altitude</dfn> attribute denotes the height of the position,
          specified in meters above the [[WGS84]] ellipsoid.
        </p>
        <p>
          The <dfn>altitudeAccuracy</dfn> attribute represents the altitude
          accuracy in meters (e.g., `10` meters).
        </p>
      </section>
      <section>
        <h4>
          `heading` attribute
        </h4>
        <p>
          The <dfn>heading</dfn> attribute denotes the direction of travel of
          the hosting device and is specified in degrees, where 0° ≤ heading
          &lt; 360°, counting clockwise relative to the true north.
        </p>
      </section>
      <section>
        <h4>
          `speed` attribute
        </h4>
        <p>
          The <dfn>speed</dfn> attribute denotes the magnitude of the
          horizontal component of the hosting device's current velocity in
          meters per second.
        </p>
      </section>
      <section>
        <h4>
          `toJSON()` method
        </h4>
        <aside class="addition" id="a2">
          <span class="marker">Candidate Addition:</span> Extend the `toJSON()`
          method functionality to the {{GeolocationCoordinates}} object,
          allowing it to be serialized into a JSON format which enhances data
          handling and integration capabilities in web applications.
        </aside>
        <p>
          <ins cite="#a2">The <dfn>toJSON()</dfn> method returns a JSON
          representation of the {{GeolocationCoordinates}} object.</ins>
        </p>
      </section>
      <section data-cite="infra">
        <h2>
          Constructing a `GeolocationPosition`
        </h2>
        <aside class="correction" id="c4">
          <span class="marker">Candidate Correction:</span> Constructor now
          takes a [=map=] of position data, a timestamp, and a boolean
          indicating high accuracy as arguments. We iterate over the map to set
          the attributes of the {{GeolocationCoordinates}}.
        </aside><ins cite="#c4">
        <p>
          <dfn>A new `GeolocationPosition`</dfn> is constructed with [=map=]
          |positionData|, {{EpochTimeStamp}} |timestamp:EpochTimeStamp|,
          boolean |isHighAccuracy|, and string |effectiveAccuracy| by
          performing the following steps:
        </p>
        <ol class="algorithm">
          <li>Let |coords:GeolocationCoordinates| be a newly created
          {{GeolocationCoordinates}} instance.
          </li>
          <li>[=map/For each=] |key| → |value| in |positionData|:
            <ol>
              <li>Set |coords|'s attribute named |key| to |value|.
              </li>
            </ol>
          </li>
          <li>Return a newly created {{GeolocationPosition}} instance with its
          {{GeolocationPosition/coords}} attribute initialized to |coords|,
          {{GeolocationPosition/timestamp}} attribute initialized to
          |timestamp|, {{GeolocationPosition/accuracyMode}} attribute
          initialized to |effectiveAccuracy|, and its
          {{GeolocationPosition/[[isHighAccuracy]]}} internal slot set to
          |isHighAccuracy|.
          </li>
        </ol></ins> <del cite="#c4">
        <p>
          <strong>A new `GeolocationPosition`</strong> is constructed with
          {{EpochTimeStamp}} |timestamp:EpochTimeStamp| and boolean
          |isHighAccuracy| by performing the following steps:
        </p>
        <ol class="algorithm">
          <li>Let |coords:GeolocationCoordinates| be a newly created
          {{GeolocationCoordinates}} instance:
            <ol>
              <li>Initialize |coord|'s {{GeolocationCoordinates/latitude}}
              attribute to a geographic coordinate in decimal degrees.
              </li>
              <li>Initialize |coord|'s {{GeolocationCoordinates/longitude}}
              attribute to a geographic coordinate in decimal degrees.
              </li>
              <li>Initialize |coord|'s {{GeolocationCoordinates/accuracy}}
              attribute to a non-negative real number. The value SHOULD
              correspond to a 95% confidence level with respect to the
              longitude and latitude values.
              </li>
              <li>Initialize |coord|'s {{GeolocationCoordinates/altitude}}
              attribute in meters above the [[WGS84]] ellipsoid, or `null` if
              the implementation cannot provide altitude information.
              </li>
              <li>Initialize |coord|'s
              {{GeolocationCoordinates/altitudeAccuracy}} attribute as
              non-negative real number, or to `null` if the implementation
              cannot provide altitude information. If the altitude accuracy
              information is provided, it SHOULD correspond to a 95% confidence
              level.
              </li>
              <li>Initialize |coord|'s {{GeolocationCoordinates/speed}}
              attribute to a non-negative real number, or as `null` if the
              implementation cannot provide speed information.
              </li>
              <li>Initialize |coord|'s {{GeolocationCoordinates/heading}}
              attribute in degrees, or `null` if the implementation cannot
              provide heading information. If the hosting device is stationary
              (i.e., the value of the {{GeolocationCoordinates/speed}}
              attribute is 0), then initialize the
              {{GeolocationCoordinates/heading}} to `NaN`.
              </li>
            </ol>
          </li>
          <li>Return a newly created {{GeolocationPosition}} instance with its
          {{GeolocationPosition/coords}} attribute initialized to |coords| and
          {{GeolocationPosition/timestamp}} attribute initialized to
          |timestamp|, and its {{GeolocationPosition/[[isHighAccuracy]]}}
          internal slot set to |isHighAccuracy|.
          </li>
        </ol></del>
      </section>
    </section>
    <section id="position_error_interface" data-dfn-for=
    "GeolocationPositionError">
      <h2>
        <dfn>GeolocationPositionError</dfn> interface
      </h2>
      <pre class="idl">
        [Exposed=Window]
        interface GeolocationPositionError {
          const unsigned short PERMISSION_DENIED = 1;
          const unsigned short POSITION_UNAVAILABLE = 2;
          const unsigned short TIMEOUT = 3;
          readonly attribute unsigned short code;
          readonly attribute DOMString message;
        };
        </pre>
      <section id="constants">
        <h3>
          Constants
        </h3>
        <dl>
          <dt>
            <dfn>PERMISSION_DENIED</dfn> (numeric value 1)
          </dt>
          <dd>
            <aside class="correction" id="c6">
              <span class="marker">Candidate Correction:</span> Updated the
              description of the `PERMISSION_DENIED` constant to clarify the
              reasons for permission denial, including [=non-secure context=]
              and user denials.
            </aside>[=Request a position=] failed because the user denied
            permission to use the API <ins cite="#c6">or the request was made
            from an [=non-secure context=]</ins>.
          </dd>
          <dt>
            <dfn>POSITION_UNAVAILABLE</dfn> (numeric value 2)
          </dt>
          <dd>
            [=Acquire a position=] failed.
          </dd>
          <dt>
            <dfn>TIMEOUT</dfn> (numeric value 3)
          </dt>
          <dd>
            The length of time specified by the {{PositionOptions/timeout}}
            member has elapsed before the user agent could successfully
            [=acquire a position=].
          </dd>
        </dl>
      </section>
      <section>
        <h4>
          `code` attribute
        </h4>
        <p>
          The <dfn>code</dfn> attribute returns the value it was [=call back
          with error|initialized to=] (see [[[#constants]]] for possible
          values).
        </p>
      </section>
      <section>
        <h4>
          `message` attribute
        </h4>
        <p>
          The <dfn>message</dfn> attribute is a developer-friendly textual
          description of the {{GeolocationPositionError/code}} attribute.
        </p>
        <aside class="note" title="Don't show .message to users!">
          <p>
            The purpose of {{GeolocationPositionError}}'s
            {{GeolocationPositionError/message}} attribute is to assist
            developers with debugging. For legacy reasons, this attribute does
            not supply language or base direction metadata and is only
            localized into English. Developers are advised to use
            {{GeolocationPositionError}}'s {{GeolocationPositionError/code}}
            attribute to create a localized experience.
          </p>
        </aside>
      </section>
    </section>
    <section>
      <h2>
        Permissions policy
      </h2>
      <p>
        This specification defines two [=policy-controlled features=]
        identified by the token strings <a>"geolocation"</a> and
        <a>"geolocation-approximate"</a>. Their [=policy-controlled
        feature/default allowlist=] is [=default allowlist/'self'=].
      </p>
      <p>
        The "geolocation" policy controls access to [=precise position=], while
        "geolocation-approximate" controls access to [=approximate position=].
        Granting "geolocation" permission implicitly grants
        "geolocation-approximate" permission as well.
      </p>
    </section>
    <section data-cite="html">
      <h2>
        Emulation
      </h2>
      <aside class="addition" id="a4">
        <span class="marker">Candidate Addition:</span> Introduce emulated
        position data to enable user-agent automation.
      </aside><ins cite="#a4">
      <p>
        For the purposes of user-agent automation and application testing, this
        document defines geolocation emulations.
      </p>
      <p>
        Each [=top-level traversable=] has an associated <dfn>emulated position
        data</dfn>, which is data representing {{GeolocationCoordinates}},
        {{GeolocationPositionError}} or null, initially null.
      </p>
      <p>
        To <dfn class="export">set emulated position data</dfn>, given
        [=navigable=] |navigable| and an |emulatedPositionData|:
      </p>
      <ol class="algorithm">
        <li>Assert |emulatedPositionData| is either null, a
        {{GeolocationCoordinates}}, or a {{GeolocationPositionError}}.
        </li>
        <li>Let |traversable| be |navigable|’s [=navigable/top-level
        traversable=].
        </li>
        <li>If |traversable| is not null:
          <ol class="algorithm">
            <li>Set |traversable|'s associated [=emulated position data=] to
            |emulatedPositionData|.
            </li>
            <li>User agents MUST consider this as a "significant change" in the
            <a href="#wait-for-change">wait for a significant change of
            geographic position</a> step.
            </li>
          </ol>
        </li>
      </ol>
      <p>
        To <dfn>get emulated position data</dfn>, given {{Geolocation}}
        |geolocation|:
      </p>
      <ol class="algorithm">
        <li>Let |navigable| be |geolocation|'s [=relevant global object=]'s
        [=associated `Document`=]'s [=node navigable=].
        </li>
        <li>If |navigable| is null, return null.
        </li>
        <li>Let |traversable| be |navigable|’s [=navigable/top-level
        traversable=].
        </li>
        <li>If |traversable| is null, return null.
        </li>
        <li>Return |traversable|'s associated [=emulated position data=].
        </li>
      </ol></ins>
    </section>
    <section id="conformance"></section>
    <section id="idl-index" class="appendix">
      <!-- All the Web IDL will magically appear here -->
    </section>
    <section class="appendix" id="index"></section>
    <section class="appendix informative">
      <h2>
        Acknowledgments
      </h2>
      <p>
        This specification builds upon earlier work in the industry, including
        research by Aza Raskin, Google Gears Geolocation API, and
        LocationAware.org.
      </p>
      <p>
        Thanks also to Alec Berntson, Alissa Cooper, Steve Block, Greg
        Bolsinga, Lars Erik Bolstad, Aaron Boodman, Dave Burke, Chris Butler,
        Max Froumentin, Shyam Habarakada, Marcin Hanclik, Ian Hickson, Brad
        Lassey, Angel Machin, Cameron McCormack, Daniel Park, Stuart Parmenter,
        Olli Pettay, Chris Prince, Arun Ranganathan, Carl Reed, Thomas
        Roessler, Dirk Segers, Allan Thomson, Martin Thomson, Doug Turner, Erik
        Wilde, Matt Womer, and Mohamed Zergaoui.
      </p>
    </section>
    <section class="informative" id="changelog">
      <h2>
        Change log
      </h2>
      <p>
        Since First Public Working Draft in 2021, <cite>Geolocation</cite> has
        received the following normative changes:
      </p>
      <script class="removeOnSave">
        function removeCommits(commit) {
          const { message, hash } = commit;
          if (["ef098b1"].includes(hash)) {
            return false;
          }
          return !/^Clarify which FPWD|^Merge pull|^tidy|^editorial|^Editiorial|^edtiorial|^chore|^refactor|^tests?|^docs|^typo|^nit/i.test(message);
        }
      </script> <rs-changelog from="FPWD" filter=
      "removeCommits"></rs-changelog>
      <p>
        Since publication of the Second Edition in 2016, this specification
        received the following substantive changes:
      </p>
      <ul>
        <li>[=Request a position=] only proceeds when a document is visible, or
        the document becomes visible.
        </li>
        <li>Clarified how caching works as part of [=acquiring a position=]:
        only last position is cached, and can be evicted at any time.
        </li>
        <li>Now relies on the [[[Permissions]]] specification to handle
        permission grants, and user interface requirements.
        </li>
        <li>The `errorCallback` is now nullable.
        </li>
        <li>The API can be controlled by [[[Permissions-Policy]]], which
        restricts how/where the API is exposed to web pages.
        </li>
        <li>The `callbacks` are no longer treated as "EventHandler" objects
        (i.e., objects that have a `.handleEvent()` method), but are now
        exclusively treated as IDL callback functions.
        </li>
        <li>The API is now only exposed in Secure Contexts (i.e., only
        available in HTTPS).
        </li>
        <li>The interfaces no longer use [[WebIDL]]'s legacy
        `[NoInterfaceObject]`, so `Geolocation` and other interface of this
        spec are now in the global scope. Also, the interfaces were renamed
        from `NavigatorGeolocation*` to just `Geolocation*`.
        </li>
      </ul>
      <p>
        See the <a href=
        "https://github.com/w3c/geolocation/commits/gh-pages">commit
        history</a> for a complete list of changes.
      </p>
    </section>
  </body>
</html>
